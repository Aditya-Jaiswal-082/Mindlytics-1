{% extends "base.html" %}
{% block css %}
<link rel="stylesheet" href="{{ url_for('static', filename='chatbot.css') }}">
{% endblock %}

{% block content %}
<section class="chatbot-section">
  <h2 class="chatbot-title">Mindlytics Health Chatbot</h2>

  <div id="chatbox" class="chatbox"></div>

  <div class="input-area">
    <input id="chat-input" type="text" placeholder="Ask me anything..." autocomplete="off" />
    <button id="send-btn">Send</button>
  </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const chatbox = document.getElementById('chatbox');
  const input = document.getElementById('chat-input');
  const sendBtn = document.getElementById('send-btn');

  function appendMessage(msg, sender) {
    const div = document.createElement('div');
    div.classList.add(sender === 'user' ? 'user-msg' : 'bot-msg');
    div.textContent = msg;
    chatbox.appendChild(div);
    chatbox.scrollTop = chatbox.scrollHeight;
  }

  async function sendMessage() {
    const msg = input.value.trim();
    if (!msg) return;
    appendMessage(msg, 'user');
    input.value = '';

    const typingDiv = document.createElement('div');
    typingDiv.classList.add('bot-msg', 'typing');
    typingDiv.textContent = 'Bot is typing...';
    chatbox.appendChild(typingDiv);
    chatbox.scrollTop = chatbox.scrollHeight;

    try {
      const res = await fetch('/api/chatbot', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: msg })
      });
      const data = await res.json();

      typingDiv.remove();
      appendMessage(data?.response || 'Sorry, I could not understand that.', 'bot');
    } catch {
      typingDiv.remove();
      appendMessage('Sorry, there was an error connecting to the server.', 'bot');
    }
  }

  sendBtn.addEventListener('click', sendMessage);
  input.addEventListener('keypress', e => {
    if (e.key === 'Enter') sendMessage();
  });
});
</script>
{% endblock %}
